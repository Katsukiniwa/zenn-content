---
title: "SQLのVIEWを調べてみた"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["SQL"]
published: true
---

## 概要

業務で PostgreSQL を使用していて初めて View を使う機会があり、View について何も知らなかったため調べてみました。

## 注意

筆者は RDBMS・SQL について初心者のため、間違った理解をしている可能性が高いです。
本文中に間違いがありましたらコメントにてご指摘頂けますと幸いです 🙏

## TL;DR

- VIEW は SQL によって中身が定義される仮想的なテーブル
- VIEW 自体はデータの実態を持たない
- VIEW は「クエリの複雑さの隠蔽」・「セキュリティの確保」・「レガシーコード退治のサポート」に役立つ

## VIEW とは何か

VIEW とは SQL によって定義される仮想的なテーブルです。
なぜテーブルではなく `仮想的な` テーブルと呼ばれるかというと、テーブルのようにストレージ上にデータを保存しないためです。
VIEW は呼び出されるたびに VIEW に定義されているクエリを実行してテーブルからデータを取得します。

![view-flow](/images/view-flow.jpg "view-flow")

この図の VIEW では employees テーブルと departments テーブルを join して特定のカラムを select しています。

## VIEW を作成・呼び出し・削除するには

VIEW の作成~削除までの一連の流れをコードで説明していきます。

例えば以下のような従業員テーブルと部署テーブルがあったとします。
従業員テーブルは部署テーブルに対する外部キーとして department_id を持ちます。

```sql
CREATE TABLE employees (
    id          INT             NOT NULL,
    birth_date  DATE            NOT NULL,
    name        VARCHAR(14)     NOT NULL,
    gender      ENUM ('M','F')  NOT NULL,
    salary      INT             NOT NULL,
    FOREIGN KEY (department_id) REFERENCES departments (id) ON DELETE CASCADE,
    PRIMARY KEY (id)
);

CREATE TABLE departments (
    id          INT             NOT NULL,
    name        VARCHAR(14)     NOT NULL,
    rank        VARCHAR(14)     NOT NULL,
    owner       VARCHAR(14)     NOT NULL,
    PRIMARY KEY (id)
);
```

VIEW の作成には `CREATE VIEW` statement を使います。
例えば以下のクエリで

- 従業員 id
- 従業員名
- 従業員の給料
- 従業員が所属する部署の名前

を取得する EmployeesWithDepartment View を作成できます。

```sql
CREATE VIEW EmployeesWithDepartment AS
SELECT
  employees.id AS id,
  employees.name AS name,
  salary,
  departments.name AS department_name
FROM employees
LEFT JOIN departments
ON Employees.department_id = departments.id;
```

次に呼び出し方です。
上記で定義した `EmployeesWithDepartment` はクエリの中で直接呼び出すことができます。

```sql
SELECT * FROM EmployeesWithDepartment;
```

ここで部署名に加えて部署ランク(departments.rank)も呼び出したくなったとします。
すでに VIEW が存在する場合は更新し、存在しない場合には VIEW を作成するためには `CREATE OR REPLACE` statement を使用します。

```sql
CREATE OR REPLACE VIEW EmployeesWithDepartment AS
SELECT
  employees.id AS id,
  employees.name AS name,
  salary,
  departments.name AS department_name
  departments.rank AS department_rank
FROM employees
LEFT JOIN departments
ON Employees.department_id = departments.id;
```

最後に不要になった VIEW は以下のクエリで削除できます。

```sql
DROP VIEW EmployeesWithDepartment;
```

## VIEW の使い所

### 複雑なクエリをシンプルにする

複数のテーブルをジョインしたりジョインした結果から何段階にも渡って計算してデータを取得するようなクエリがあった場合、クエリ内のロジックを VIEW として定義することでテーブルを呼び出す感覚でクエリを実行することができます。
実際、自分が今回の業務で VIEW を扱った目的はこのためでした。

### セキュリティの確保

VIEW に対して permission を設定することて特定のユーザに必要なデータのみ後悔するよう設定することができます。
今回の調査ではセキュリティ確保の具体的な方法について調べることが時間的に難しかったため次回までの宿題とします。
軽く調べただけですが、例えば[MySQL の公式リファレンス](https://dev.mysql.com/doc/refman/8.0/ja/create-view.html)では以下のように記されていました。

> DEFINER および SQL SECURITY 句は、そのビューを参照しているステートメントの実行時に、そのビューに対するアクセス権限を確認するときにどの MySQL アカウントを使用するかを決定します。 有効な SQL SECURITY 特性値は、DEFINER (デフォルト) および INVOKER です。 これらは、それぞれ、そのビューを定義したユーザーまたは呼び出したユーザーが必要な権限を持っている必要があることを示します。

### レガシーコード退治

レガシーコード退治においてテーブルのリファクタリングが難しい場合、テーブルを同じ名前のビューに置き換えるという手法が考えられます。既存のテーブルと同じ VIEW を用意しておくことでテーブルのスキーマが変更されても VIEW は影響を受けないため安全にリファクタリングを進めることができます。
今回の調査では VIEW を使ったレガシーコード退治の事例を見つけることができなかったためセキュリティの確保と同様にこちらも次回の宿題とします。

## 最後に

今回の VIEW の調査を通して VIEW が何であるかや VIEW に関する DDL、VIEW の使い所などをざっくりと調べられて勉強になりました。
PostgreSQL では VIEW とは別に Materialized VIEW という VIEW とテーブルの中間の性質を持った VIEW があったり一部の VIEW の使い所について調べられなかったため次回はこれらについて調査できたらと思います。

## 参考記事

[（データベース）view の使い所](https://zenn.dev/praha/articles/480ab855916962)
[Views (Virtual Tables) in SQL](https://www.datacamp.com/tutorial/views-in-sql)
[Why do you create a View in a database?](https://stackoverflow.com/questions/1278521/why-do-you-create-a-view-in-a-database)
[What is an SQL View](https://learnsql.com/blog/sql-view/)
